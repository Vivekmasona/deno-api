<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>100 m Proximity Demo</title>
</head>
<body>
  <h3>Enter your name:</h3>
  <input id="name" placeholder="Your name">
  <button id="start">Start</button>
  <pre id="log"></pre>

  <script>
    const id = localStorage.getItem("id") || crypto.randomUUID();
    localStorage.setItem("id", id);
    let ws, timer;
    const log = (t) => document.getElementById("log").textContent += t + "\n";

    document.getElementById("start").onclick = () => {
      const name = document.getElementById("name").value || "Anon";
      ws = new WebSocket("ws://" + location.host);
      ws.onopen = () => {
        ws.send(JSON.stringify({ type: "register", id, name }));
        log("Connected as " + name);
        timer = setInterval(sendLocation, 2000);
      };
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === "near") {
          alert(`${msg.name} ${msg.name} ${msg.name} (${msg.distance} m)`);
        }
      };
      ws.onclose = () => clearInterval(timer);
    };

    function sendLocation() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition((p) => {
        ws.send(JSON.stringify({
          type: "update",
          id,
          lat: p.coords.latitude,
          lon: p.coords.longitude,
        }));
      });
    }
  </script>
</body>
</html>
